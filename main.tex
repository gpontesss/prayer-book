\documentclass[
    twoside,
    DIV=14,
    fontsize=12pt,
    paper=12cm:18cm,
    headsepline=true,
    parskip=half*,
    % draft,
]{scrbook}

\usepackage{fontspec}
\usepackage{suffix}
\usepackage{xcolor}
\usepackage{graphicx}
\usepackage{svg}
\usepackage[portuguese]{babel}
% \usepackage{background}
\usepackage[
    markcase=upper,
]{scrlayer-scrpage}
\usepackage{subfiles}

\newcommand\booktitle{Livro de Orações}

% source: https://tex.stackexchange.com/questions/801/what-is-the-easiest-way-to-get-borders-around-a-page-in-latex
% \usetikzlibrary{calc}
% \SetBgScale{1}
% \SetBgAngle{0}
% \SetBgColor{black}
% \SetBgContents{
% \begin{tikzpicture}[overlay,remember picture]
%     \draw [line width=1pt,rounded corners=4pt,]
%         ($ (current page.north west) + (1mm,-1mm) $)
%         rectangle
%         ($ (current page.south east) + (-1mm,1mm) $);
% \end{tikzpicture}}

% TODO: extract common functions and format setup to a common package

% font setup ===================================================================

\setmainfont{EBGaramond-Medium}
\setsansfont{GentiumBookPlus}
% \setmainfont{EBGaramond-Medium}
% \setsansfont{EBGaramond-Medium}
% \setsansfont{GentiumBookPlus}

% domain functions =============================================================

\definecolor{docolor}{HTML}{e05e6d}
\newcommand{\dotext}[1]{{\color{docolor}#1}}
\newcommand{\dotextit}[1]{{\dotext{\textit{#1}}}}

% stylization of chapters and sections =========================================

\RedeclareSectionCommand[
    beforeskip=\parskip,
    afterskip=\parskip,
]{section}
\renewcommand{\sectionlinesformat}[4]{%
    \footnotesize\centering{\dotext{\uppercase{#4}}}\vspace*{-2\parskip}}
\WithSuffix\newcommand\Section*[2]{%
    \dotext{\section*{#1}{\small\centering\textit{#2}\par}\vspace*{-\parskip}}}

\newtoks\chapheader
\chapheader{headers/byzantine-circles}

\RedeclareSectionCommand[
    beforeskip=0pt,
    afterskip=\parskip,
]{chapter}
\renewcommand{\chapterlinesformat}[3]{%
    % \includesvg[width=\textwidth]{\the\chapheader}\break{}%
    \normalfont\Huge\centering{\uppercase{#3}}}
\newcommand{\Chapter}[3][headers/byzantine-circles]{%
    \chapheader{#1}
    \chapter[#2 #3]{#2}\vspace*{-2\parskip}{\centering\textit{\Large{#3}}\par}}

% header/footer styles =========================================================

\addtokomafont{headsepline}{\color{docolor}}
\KOMAoptions{headsepline=.5pt:\textwidth}

\renewcommand*{\chaptermarkformat}{\footnotesize\normalfont}

\pagestyle{scrheadings}
\automark*{chapter}
\cehead{\MakeMarkcase{\chaptermarkformat{\booktitle}}}
\lehead{}
\cohead{\leftmark}

\newcommand{\pagenumformat}[1]{\footnotesize\normalfont\dotext{#1}}
\lefoot*{}
\cefoot*{\pagenumformat{\thepage}}
\rofoot*{}
\cofoot*{\pagenumformat{\thepage}}

\setlength{\headsep}{.5\parskip}
\setlength{\footskip}{3.5\parskip}

% common prayers/text ==========================================================

\newcommand{\reader}{\textbf{\dotextit{Leitor: }}}
\newcommand{\priest}{\textbf{\dotextit{Sacerdote: }}}
\newcommand{\theotokion}{\textbf{\dotextit{Theotokion: }}}
\newcommand{\eirmos}{\textbf{\dotextit{Eirmos: }}}
\newcommand{\refrain}{\textbf{\dotextit{Refrão: }}}
\newcommand{\Doxology}{\textit{Glória ao Pai, ao Filho, e ao Espírito Santo,
    agora e sempre e pelos séculos dos séculos. Amém.}}
\newcommand{\doxology}{\textit{Glória ao Pai, ao Filho, e ao Espírito Santo.}}
\newcommand{\nowandever}{\textit{Agora e sempre e pelos séculos dos séculos. Amém.}}
\newcommand{\mercy}{Senhor, tem piedade.}
\newcommand{\repeatn}[1]{\dotextit{(#1 vezes)}}
\newcommand{\thrice}{\repeatn{3}}
\newcommand{\letusworship}{%
Vinde, adoremos a Deus, nosso Rei. \\
Vinde, adoremos e prostremo-nos diante de Cristo, nosso Rei e nosso Deus. \\
Vinde, adoremos e prostremo-nos diante do próprio Cristo, nosso Rei e Deus.}
\newcommand{\ourFather}{%
Pai nosso, que estás nos Céus, Santificado seja o Teu Nome, venha a
nós o Teu Reino, seja feita a Tua vontade, assim na terra como no Céu. O Pão
nosso de cada dia nos dá hoje, perdoa-nos as nossas dívidas, assim como nós
perdoamos aos nossos devedores, e não nos deixes cair em tentação, mas
livra-nos do maligno.}
\newcommand{\comforter}{%
Rei dos Céus, Consolador, Espírito de Verdade, Tu que estás presente em tudo e
enches tudo, Tesouro de bens e Doador da vida, vem e habita em nós, purifica-nos
de toda a impureza e salva as nossas almas, Tu que és bom.}
\newcommand{\trisagion}{Santo Deus, Santo Poderoso, Santo Imortal, tem piedade de nós!}

% ==============================================================================

\begin{document}

\title{\booktitle}
\subtitle{Versão adaptada\break{}Paróquia da Catedral Ortodoxa de São Nicolau}
\date{2023}
\publishers{}

\maketitle{}%
\raggedbottom{}

\tableofcontents{}
\cleardoubleevenpage{}

\mainmatter{}

\subfile{blocks/matins.tex}
\subfile{blocks/during-day.tex}
\subfile{blocks/vespers.tex}
\subfile{blocks/supplicatory-canon-christ.tex}
\subfile{blocks/supplicatory-canon-theotokos.tex}
\subfile{blocks/canon-guardian-angel.tex}
\subfile{blocks/akathist-sweetest-lord-jesus-christ.tex}
\subfile{blocks/akathist-theotokos.tex}
\subfile{blocks/communion-preparation.tex}
\subfile{blocks/communion-thanksgiving.tex}
\subfile{blocks/vespers-selections.tex}
\subfile{blocks/matins-selections.tex}
\subfile{blocks/divine-liturgy.tex}

\end{document}
